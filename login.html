<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login — OroFlow</title>
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700;800&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}html{-webkit-font-smoothing:antialiased}body{font-family:'Outfit',sans-serif;background:#f5f5f0;background-image:radial-gradient(circle,#d5d5cf 1px,transparent 1px);background-size:28px 28px;background-attachment:fixed;color:#1a1a1a;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}h1,h2,h3{font-family:'Space Grotesk',sans-serif;letter-spacing:-.03em}
.login-container{width:100%;max-width:420px;animation:fadeIn .5s cubic-bezier(.4,0,.2,1)}
.card{background:#ffffff;border:1px solid #e0e0da;border-radius:20px;padding:44px 36px;box-shadow:0 2px 8px rgba(0,0,0,.06),0 8px 32px rgba(0,0,0,.06)}
.brand{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:32px;text-decoration:none}
.brand-logo{width:38px;height:38px;background:#1a1a1a;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Space Grotesk',sans-serif;font-weight:800;font-size:13px;color:#E2FF00;transition:all .25s cubic-bezier(.4,0,.2,1)}
.brand:hover .brand-logo{box-shadow:0 0 0 3px rgba(226,255,0,.10)}
.brand-name{font-family:'Space Grotesk',sans-serif;font-size:22px;font-weight:800;color:#1a1a1a;letter-spacing:-.04em}
.card h1{font-size:26px;font-weight:800;text-align:center;margin-bottom:6px;letter-spacing:-.04em}
.card .subtitle{text-align:center;color:#888;font-size:14px;margin-bottom:28px;font-weight:400}
.form-group{margin-bottom:18px}
.form-group label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:7px}
.form-group input{width:100%;padding:12px 15px;background:#f5f5f0;border:1px solid #e0e0da;border-radius:10px;color:#1a1a1a;font-family:'Outfit',sans-serif;font-size:14px;transition:all .25s cubic-bezier(.4,0,.2,1);outline:none}
.form-group input::placeholder{color:#888}
.form-group input:focus{border-color:#1a1a1a;box-shadow:0 0 0 3px rgba(226,255,0,.10)}
.btn-submit{width:100%;padding:13px;background:#1a1a1a;color:#E2FF00;border:none;border-radius:11px;font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);margin-top:6px}
.btn-submit:hover{background:#111;box-shadow:0 4px 20px rgba(0,0,0,.15);transform:translateY(-1px)}
.btn-submit:active{transform:translateY(0)}
.btn-submit:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.alt-link{text-align:center;margin-top:22px;color:#888;font-size:14px}
.alt-link a{color:#1a1a1a;text-decoration:none;font-weight:600;transition:all .25s cubic-bezier(.4,0,.2,1)}
.alt-link a:hover{color:#111}
.legal{text-align:center;margin-top:16px;font-size:12px;color:#888}
.legal a{color:#555;text-decoration:none;margin:0 3px}
.legal a:hover{text-decoration:underline}
.error-msg{background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.12);color:#dc2626;padding:11px 14px;border-radius:10px;font-size:13px;margin-bottom:18px;display:none;text-align:center;font-weight:500}
.success-msg{background:rgba(22,163,74,.06);border:1px solid rgba(22,163,74,.12);color:#16a34a;padding:11px 14px;border-radius:10px;font-size:13px;margin-bottom:18px;display:none;text-align:center;font-weight:500}
.pw-wrapper{position:relative}
.pw-wrapper input{width:100%;padding-right:44px}
.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:#888;font-size:16px;padding:4px;line-height:1;transition:color .2s}
.pw-toggle:hover{color:#1a1a1a}
.remember-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;margin-top:-6px}
.remember-row input[type="checkbox"]{width:16px;height:16px;accent-color:#1a1a1a;cursor:pointer}
.remember-row label{font-size:13px;color:#555;cursor:pointer;font-weight:500}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@media(max-width:480px){.card{padding:32px 22px;border-radius:16px}.card h1{font-size:23px}}
</style>
</head>
<body>
<div class="login-container">
<div class="card">
<a href="/" class="brand"><div class="brand-logo">O+</div><span class="brand-name">OroFlow</span></a>
<h1>Welcome Back</h1>
<p class="subtitle">Sign in to continue to OroFlow</p>
<div class="success-msg" id="successMsg"></div>
<div class="error-msg" id="errorMsg"></div>
<form id="loginForm" onsubmit="return handleLogin(event)">
<div class="form-group"><label>Email Address</label><input type="email" id="email" name="email" placeholder="you@company.com" required></div>
<div class="form-group"><label>Password</label><div class="pw-wrapper"><input type="password" id="password" name="password" placeholder="Enter your password" required><button type="button" class="pw-toggle" onclick="togglePw(this)">&#128065;</button></div></div>
<div class="remember-row"><input type="checkbox" id="rememberMe" checked><label for="rememberMe">Remember me</label></div>
<button type="submit" class="btn-submit" id="submitBtn">Sign In</button>
</form>
<p class="alt-link">Don't have an account? <a href="/signup.html">Sign up</a></p>
<p class="legal"><a href="/terms.html">Terms</a>&middot;<a href="/privacy.html">Privacy</a></p>
</div>
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
<script>
// ============================================
// SUPABASE INIT
// ============================================
// These are safe to expose publicly — RLS policies
// control what each user can actually access.
var SUPABASE_URL = 'https://xsqfdhymfgrobzovfgjf.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcWZkaHltZmdyb2J6b3ZmZ2pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODA3MTgsImV4cCI6MjA4NzY1NjcxOH0.D4SqSsR8O8HAwjHFr03hYc1NcPHsqLQnJT3jH1yaMpU';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function togglePw(btn) {
    var input = btn.previousElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '&#128064;';
    } else {
        input.type = 'password';
        btn.innerHTML = '&#128065;';
    }
}

// Load saved email if remembered
(function loadSavedEmail() {
    var saved = localStorage.getItem('oroflow_email');
    if (saved) {
        document.getElementById('email').value = saved;
    }
})();

// ============================================
// AUTO-REDIRECT IF ALREADY LOGGED IN
// ============================================
// Replaces: fetch('/auth.php?action=check')
// Supabase stores the session in localStorage.
// getSession() checks if a valid token exists.
(async function checkExistingSession() {
    var result = await sb.auth.getSession();
    if (result.data.session) {
        // User is already logged in — skip login page
        window.location.href = '/dashboard.html';
    }
})();

// ============================================
// SHOW SUCCESS MESSAGE IF JUST REGISTERED
// ============================================
// Same as before — checks URL for ?registered=true
var params = new URLSearchParams(window.location.search);
if (params.get('registered') === 'true') {
    var s = document.getElementById('successMsg');
    s.textContent = 'Account created! Please sign in.';
    s.style.display = 'block';
}

// ============================================
// LOGIN HANDLER
// ============================================
// Replaces: fetch('/auth.php?action=login', ...)
// Uses Supabase signInWithPassword which:
// 1. Validates email + password against auth.users
// 2. Returns a JWT session token
// 3. Automatically stores it in localStorage
// 4. All future Supabase calls use this token for RLS
async function handleLogin(e) {
    e.preventDefault();

    var btn = document.getElementById('submitBtn');
    var errEl = document.getElementById('errorMsg');
    var sucEl = document.getElementById('successMsg');

    // Reset UI
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    btn.disabled = true;
    btn.textContent = 'Signing in...';

    var email = document.getElementById('email').value.trim().toLowerCase();
    var password = document.getElementById('password').value;

    // Call Supabase Auth
    var result = await sb.auth.signInWithPassword({
        email: email,
        password: password
    });

    if (result.error) {
        // Map Supabase error messages to user-friendly ones
        var msg = result.error.message;
        if (msg === 'Invalid login credentials') {
            msg = 'Invalid email or password.';
        } else if (msg === 'Email not confirmed') {
            msg = 'Please check your email to confirm your account.';
        }
        errEl.textContent = msg;
        errEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Sign In';
    } else {
        // Success — session is auto-stored by Supabase
        if (document.getElementById('rememberMe').checked) {
            localStorage.setItem('oroflow_email', email);
        } else {
            localStorage.removeItem('oroflow_email');
        }
        window.location.href = '/dashboard.html';
    }

    return false;
}
</script>
</body>
</html>
